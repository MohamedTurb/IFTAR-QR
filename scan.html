<!doctype html>
<html lang="en">
<head>
    <link rel="icon" href="data:,">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QR Check-in</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{font-family:system-ui;margin:16px;background:#0b1220;color:#fff}
.card{background:#111a2e;border:1px solid #223055;border-radius:12px;padding:14px;margin:12px 0}
button,input{padding:10px;border-radius:8px;border:1px solid #2b3b68;background:#0b1220;color:#fff}
.ok{border-color:green}
.bad{border-color:red}
</style>
</head>

<body>

<h2>QR Check-in</h2>

<input id="usedBy" value="Gate-A1"/>
<button onclick="start()">Start Scan</button>
<button onclick="stop()">Stop</button>

<div id="reader"></div>
<div id="result" class="card">Result will appear here</div>

<script>

const API_URL = "https://script.google.com/macros/s/AKfycbzfm1r2O32I88scfQafhPcTetvK_8LPOOgzYR5xvjgALQZSYNF14jwHLjwnojTV-kg/exec";
const API_KEY = "ECU_EVENT_2026_SECRET_987654";

let scanner = null;

function show(ok,msg){
document.getElementById("result").className = ok ? "card ok" : "card bad";
document.getElementById("result").innerText = msg;
}

async function checkin(ticket){

  const url =
    API_URL +
    "?action=checkin" +
    "&ticket=" + encodeURIComponent(ticket.trim()) +
    "&usedBy=" + encodeURIComponent((document.getElementById("usedBy").value || "Gate").trim()) +
    "&key=" + encodeURIComponent(API_KEY);

  let data;
  try{
    const res = await fetch(url, { method: "GET" });
    data = await res.json();
  }catch(e){
    show(false, "Network/API Error: " + e);
    return;
  }

  if(data.ok){
    show(true, "ACCEPTED");
    navigator.vibrate?.(80);
  }else{
    show(false, data.reason || "REJECTED");
    navigator.vibrate?.([60,60,60]);
  }
}
</script>

const data = await res.json();

if(data.ok){
show(true,"ACCEPTED");
navigator.vibrate?.(80);
}else{
show(false,data.reason || "REJECTED");
navigator.vibrate?.([60,60,60]);
}

}

async function start(){

scanner = new Html5Qrcode("reader");

await scanner.start(
{ facingMode:"environment" },
{ fps:10, qrbox:250 },
(decodedText)=>{
checkin(decodedText);
}
);

}

async function stop(){
if(scanner){
await scanner.stop();
scanner.clear();
}
}

</script>

</body>
</html>